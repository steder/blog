---
layout: post
title: "Asynchronous Access to My Desktop Pictures"
date: 2010-08-09
comments: false
categories:
 - twisted
 - python
---

<div class='post'>
I've been working a lot with <a href="http://www.twistedmatrix.com/">Twisted</a> lately so I thought people might appreciate<br />a fun example of how one could download a bunch of files quickly using<br />asynchronous IO.<br /><br />Anyway, this script currently grabs a ton of nice hi resolution<br />National Geographic photos. Enjoy! (<a href="http://penzilla.net/NatGeoImages/natgeo.py">Download the python file directly</a>)<br /><br /><br /><a name='more'></a><div class="highlight"></div><pre><span class="c">#!/usr/bin/env python</span><br /><span class="kn">import</span> <span class="nn">os</span><br /><br /><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">task</span><br /><span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span><br /><span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">client</span><br /><br /><span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1109wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1102wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1026wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1019wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1013wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/1005wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0928wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0921wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0914wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0907wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0831wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0824wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br />    <span class="sd">"""http://ngm.nationalgeographic.com/photo-contest/2009/img/wallpaper/0817wallpaper-%s_1600.jpg"""</span><span class="p">,</span><br /><span class="p">]</span><br /><br /><br /><span class="k">def</span> <span class="nf">generateDownloadArgs</span><span class="p">(</span><span class="n">urls</span><span class="p">):</span><br />    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span><br />        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span><br />            <span class="n">nurl</span> <span class="o">=</span> <span class="n">url</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span><br />            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">nurl</span><span class="p">)</span><br />            <span class="k">yield</span> <span class="n">nurl</span><span class="p">,</span> <span class="n">path</span><br /><br />            <br /><span class="k">def</span> <span class="nf">parallel</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">):</span><br />    <span class="n">coop</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">Cooperator</span><span class="p">()</span><br />    <span class="n">work</span> <span class="o">=</span> <span class="p">(</span><span class="nb">callable</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">named</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">)</span><br />    <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">DeferredList</span><span class="p">([</span><span class="n">coop</span><span class="o">.</span><span class="n">coiterate</span><span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">count</span><span class="p">)])</span><br /><br /><br /><span class="k">def</span> <span class="nf">handleError</span><span class="p">(</span><span class="n">x</span><span class="p">):</span><br />    <span class="sd">"""Any error reporting or error handling we want to do"""</span><br /><br /><br /><span class="k">def</span> <span class="nf">handleSuccess</span><span class="p">(</span><span class="n">x</span><span class="p">):</span><br />    <span class="sd">"""Anything extra we want to do on a successful download"""</span><br /><br /><br /><span class="k">def</span> <span class="nf">download</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)):</span><br />    <span class="n">d</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">downloadPage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span><br />    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">handleSuccess</span><span class="p">)</span><br />    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">handleError</span><span class="p">)</span><br />    <span class="k">return</span> <span class="n">d</span><br /><br /><br /><span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span><br />    <span class="n">finished</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">generateDownloadArgs</span><span class="p">(</span><span class="n">URLS</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">download</span><span class="p">)</span><br />    <span class="n">finished</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">handleError</span><span class="p">)</span><br />    <span class="n">finished</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ignore</span><span class="p">:</span> <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span><br />    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><br /></pre></div>
